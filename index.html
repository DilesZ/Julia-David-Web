<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Julia y David - Nuestra Historia de Amor</title>
    <link href="https://fonts.googleapis.com/css2?family=Parisienne&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="frontend/styles.css">
    <style>
        /* Estilos para el Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.5s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: #d65a7b;
            text-decoration: none;
        }
        .modal h2 {
            font-family: 'Parisienne', cursive;
            color: #d65a7b;
            text-align: center;
        }
        .modal input, .modal textarea, .modal button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .modal button {
            background-color: #d65a7b;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .modal button:hover {
            background-color: #ff6f61;
        }
        #user-status {
            display: none;
            align-items: center;
            gap: 15px;
        }
        #user-status span {
            font-family: 'Roboto', sans-serif;
            color: #d65a7b;
            font-size: 1.1rem;
        }
        #logout-btn {
            background: #ff6f61;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="heart-particles"></div>

    <!-- Modales -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-login-modal">&times;</span>
            <h2>Iniciar Sesión</h2>
            <input type="text" id="username" placeholder="Usuario (Julia o David)">
            <input type="password" id="password" placeholder="Contraseña">
            <button id="login-modal-btn">Entrar</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-admin-modal">&times;</span>
            <h2>Panel de Administración</h2>
            <h3>Editar Contenido</h3>
            <textarea id="historia-text-admin" rows="5"></textarea>
            <button id="save-historia">Guardar Historia</button>
            <textarea id="planes-text-admin" rows="5"></textarea>
            <button id="save-planes">Guardar Planes</button>
            <h3>Subir Imagen al Slider</h3>
            <input type="file" id="admin-upload-image" accept="image/*">
            <button id="upload-image-btn-admin">Subir Imagen</button>
            <h3>Calendario</h3>
            <a href="https://calendar.google.com/calendar/u/0?cid=juliaydavid20092025@gmail.com" target="_blank">Administrar en Google Calendar</a>
        </div>
    </div>

    <nav>
        <ul>
            <li><a href="#inicio">Inicio</a></li>
            <li><a href="#historia">Nuestra Historia</a></li>
            <li><a href="#momentos">Momentos</a></li>
            <li><a href="#calendario">Nuestro Calendario</a></li>
            <li><a href="#planes">Nuestros Planes</a></li>
            <li id="login-nav-item"><a href="#" id="login-nav-btn">Iniciar Sesión</a></li>
            <li id="user-status">
                <span id="user-name"></span>
                <button id="admin-panel-btn">Admin</button>
                <button id="logout-btn">Cerrar Sesión</button>
            </li>
        </ul>
    </nav>
    
    <header id="inicio">
        <div>
            <h1>Julia & David</h1>
            <p>Juntos, escribiendo nuestra historia de amor</p>
        </div>
    </header>

    <section id="historia" class="fade-in">
        <h2>Nuestra Historia</h2>
        <p id="historia-text"></p>
    </section>

    <section id="momentos" class="gallery fade-in">
        <h2>Nuestros Momentos</h2>
        <div class="slider">
            <div class="slider-container" id="slider-container"></div>
            <button class="slider-prev">◄</button>
            <button class="slider-next">►</button>
        </div>
        <div class="upload-section">
            <p>Sube nuevas fotos aquí. Si no has iniciado sesión, se te pedirá que lo hagas.</p>
            <input type="file" id="upload-image" accept="image/*">
        </div>
    </section>

    <section id="calendario" class="fade-in">
        <h2>Nuestro Calendario</h2>
        <div id="calendar">
            <iframe src="https://calendar.google.com/calendar/embed?src=juliaydavid20092025%40gmail.com&ctz=Europe%2FMadrid" style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
        </div>
        <div class="countdown">Llevamos <span id="anniversary-countdown"></span> juntos.</div>
    </section>

    <section id="planes" class="fade-in">
        <h2>Nuestros Planes</h2>
        <p id="planes-text"></p>
        <div class="message-form">
            <h3>Envíame un mensaje romántico</h3>
            <textarea id="message-input" placeholder="Escribe tu mensaje aquí..." rows="4"></textarea>
            <button id="send-message">Enviar</button>
        </div>
        <div class="message-display" id="message-display"></div>
    </section>

    <footer>
        <p>Con amor, Julia & David</p>
    </footer>

    <button class="dark-mode-toggle" id="dark-mode-toggle">Modo Oscuro</button>

    <script>
        const API_URL = 'https://juliaydavid-backend.onrender.com';

        // Lógica de Modales
        const loginModal = document.getElementById('login-modal');
        const adminModal = document.getElementById('admin-modal');
        const loginNavBtn = document.getElementById('login-nav-btn');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        
        document.getElementById('close-login-modal').onclick = () => loginModal.style.display = 'none';
        document.getElementById('close-admin-modal').onclick = () => adminModal.style.display = 'none';
        loginNavBtn.onclick = (e) => { e.preventDefault(); loginModal.style.display = 'block'; };
        adminPanelBtn.onclick = () => { loadAdminContent(); adminModal.style.display = 'block'; };

        window.onclick = (event) => {
            if (event.target == loginModal) loginModal.style.display = "none";
            if (event.target == adminModal) adminModal.style.display = "none";
        };

        // Lógica de Autenticación
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (token && username) {
                document.getElementById('login-nav-item').style.display = 'none';
                const userStatus = document.getElementById('user-status');
                userStatus.style.display = 'flex';
                document.getElementById('user-name').textContent = `Conectado: ${username}`;
                loadMessages();
            } else {
                document.getElementById('login-nav-item').style.display = 'block';
                document.getElementById('user-status').style.display = 'none';
            }
        }

        document.getElementById('login-modal-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    loginModal.style.display = 'none';
                    checkLoginStatus();
                } else {
                    alert(data.error || 'Error al iniciar sesión.');
                }
            } catch (err) {
                alert('Error de conexión.');
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            checkLoginStatus();
            document.getElementById('message-display').innerHTML = '';
        });

        // Cargar contenido principal
        async function loadContent() {
            const res = await fetch(`${API_URL}/api/content`);
            const contents = await res.json();
            document.getElementById('historia-text').textContent = contents.find(c => c.section === 'historia')?.text || '';
            document.getElementById('planes-text').textContent = contents.find(c => c.section === 'planes')?.text || '';
        }

        // Cargar imágenes
        async function loadImages() {
            const res = await fetch(`${API_URL}/api/images`);
            const images = await res.json();
            const sliderContainer = document.getElementById('slider-container');
            sliderContainer.innerHTML = '';
            images.forEach(img => {
                const slide = document.createElement('div');
                slide.classList.add('slider-slide');
                slide.innerHTML = `<img src="${API_URL}${img.path}" alt="${img.description}">`;
                sliderContainer.appendChild(slide);
            });
            initSlider();
        }
        
        // Cargar contenido del panel de admin
        async function loadAdminContent() {
            const res = await fetch(`${API_URL}/api/content`);
            const contents = await res.json();
            document.getElementById('historia-text-admin').value = contents.find(c => c.section === 'historia')?.text || '';
            document.getElementById('planes-text-admin').value = contents.find(c => c.section === 'planes')?.text || '';
        }

        // Acciones del Panel de Admin
        async function saveData(section, text) {
            const token = localStorage.getItem('token');
            if (!token) { alert('Sesión expirada.'); return; }
            await fetch(`${API_URL}/api/content`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ section, text })
            });
            alert('Contenido actualizado.');
            loadContent();
            adminModal.style.display = 'none';
        }
        document.getElementById('save-historia').onclick = () => saveData('historia', document.getElementById('historia-text-admin').value);
        document.getElementById('save-planes').onclick = () => saveData('planes', document.getElementById('planes-text-admin').value);

        document.getElementById('upload-image-btn-admin').addEventListener('click', async () => {
             const fileInput = document.getElementById('admin-upload-image');
             handleImageUpload(fileInput);
        });

        // Subir Imagen
        document.getElementById('upload-image').addEventListener('change', function(e) {
            handleImageUpload(e.target);
        });
        
        async function handleImageUpload(fileInput) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesión para subir imágenes.');
                loginModal.style.display = 'block';
                return;
            }
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`${API_URL}/api/images`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (response.ok) {
                    alert('Imagen subida.');
                    loadImages();
                    fileInput.value = '';
                    if(adminModal.style.display === 'block') adminModal.style.display = 'none';
                } else {
                    alert('Error al subir la imagen.');
                }
            } catch (err) {
                alert('Error de conexión al subir imagen.');
            }
        }
        
        // Mensajes
        async function loadMessages() {
            const token = localStorage.getItem('token');
            if (!token) return;
            const res = await fetch(`${API_URL}/api/messages`, { headers: { 'Authorization': `Bearer ${token}` } });
            const messages = await res.json();
            const display = document.getElementById('message-display');
            display.innerHTML = '';
            messages.forEach(msg => {
                const p = document.createElement('p');
                p.textContent = `${msg.author}: ${msg.text} (${new Date(msg.date).toLocaleDateString()})`;
                display.appendChild(p);
            });
        }

        document.getElementById('send-message').addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesión para enviar mensajes.');
                loginModal.style.display = 'block';
                return;
            }
            const text = document.getElementById('message-input').value.trim();
            if (!text) return;
            await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ text })
            });
            document.getElementById('message-input').value = '';
            loadMessages();
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
            loadImages();
            checkLoginStatus();
            // El resto de funciones de UI (slider, dark mode, etc.) se quedan igual
        });
        
        // --- Pegar aquí el resto del JavaScript original (slider, dark mode, countdown, etc.) ---
        
        // Slider personalizado
        let currentIndex = 0;
        function initSlider() {
            const slider = document.querySelector('.slider-container');
            if (!slider || !slider.children.length) return;
            const slides = slider.children;
            const prevBtn = document.querySelector('.slider-prev');
            const nextBtn = document.querySelector('.slider-next');
            
            function updateSlider() {
                slider.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
            prevBtn.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + slides.length) % slides.length;
                updateSlider();
            });
            nextBtn.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % slides.length;
                updateSlider();
            });
        }

        // Dark mode
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            darkModeToggle.textContent = document.body.classList.contains('dark-mode') ? 'Modo Claro' : 'Modo Oscuro';
        });

        // Heart particles
        const heartParticles = document.querySelector('.heart-particles');
        function createHeart() {
            const heart = document.createElement('div');
            heart.classList.add('heart-particle');
            heart.innerHTML = '♡';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.animationDuration = Math.random() * 5 + 5 + 's';
            heartParticles.appendChild(heart);
            setTimeout(() => heart.remove(), 10000);
        }
        setInterval(createHeart, 1000);
        
        // Countdown
        const startDate = new Date('2025-09-20');
        const countdownElement = document.getElementById('anniversary-countdown');
        function updateCountdown() {
            const now = new Date();
            let years = now.getFullYear() - startDate.getFullYear();
            let months = now.getMonth() - startDate.getMonth();
            let days = now.getDate() - startDate.getDate();

            if (days < 0) {
                months--;
                days += new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            
            let parts = [];
            if (years > 0) parts.push(`${years} año${years > 1 ? 's' : ''}`);
            if (months > 0) parts.push(`${months} mes${months > 1 ? 'es' : ''}`);
            if (days > 0 || parts.length === 0) parts.push(`${days} día${days !== 1 ? 's' : ''}`);
            
            countdownElement.textContent = parts.join(', ');
        }
        setInterval(updateCountdown, 1000);

    </script>
</body>
</html>
